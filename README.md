# Унивидение

## Общая информация:

Первая версия бота была написана в 2023 году за пару бессонных ночей. Хоть код и выглядел намного проще, чем тот, который был до меня – он был далеко не идеальным. Из-за переусложненной логики страдала роботоспособность. В 2024 я переписал бота с использованием двух модных библиотек (одна для работы с инлайн кнопками, а другая для мультиязычности) + добавил несколько упрощений в логику. Сейчас код выглядит легко. Для его понимания нужно немного разбираться – все нужные ссылки я приложил ниже. В экстренных случаях можно написать мне t.me/romanychev

## Для организаторов:

Работа организаторов заключается в следующей последовательности действий:

<aside>
❗ Некоторые приведенные ниже команды имеют дополнительные параметры. Семантику команд смотрите в разделе ниже

</aside>

<aside>
❗ Перед работой с ботом убедитесь, что разработчик добавил вас в администраторы

</aside>

1. Перед всеми этапами отправить боту файл со списком почт и факультетов. При этом факультеты должны быть названы так, как они должны отображаться в клавиатуре бота (используйте инструмент в экселе ”заменить все”, чтобы заменить вхождения длинных названий на короткие). Первая строчка таблицы должна быть заполнена произвольными названиями. Первый столбец должен включать в себя названия факультетов. Второй столбец - почты. Третий столбец произвольный. Четвертый столбец страну студента. Если страна студента не равна строчке "Россия", то студент будет помечен как КИО.
2. Перед каждым этапом необходимо удалить все ненужные факультеты и добавить все нужные (те, которые будут на ближайшем этапе). Названия также должны быть короткими и совпадать с теми, что есть в табличке с почтами. Делать это можно через команды /show, /add, /del.
3. Чтобы запустить голосование необходимо отправить команду /event_start. Чтобы завершить голосование – отправьте команду /event_stop.
4. Чтобы получить результаты в виде таблички нужно отправить /get_result.
5. Перед очередным этапом повторите пункты начиная с п. 1.

## Для программистов:

Бот написан на библиотеке aiogram 3 версии. 

Важным дополнением является использование библиотеки aiogram_dialog. Она сильно упрощает работу с inline клавиатурами. 

Еще одна библиотека fluentogram предназначена для интернационализации – чтобы было легко делать мультиязычных ботов. 

Бот обернут в docker контейнер. Перед запуском необходимо убедиться:

1. Что в корне проекта лежит файл .env с переменными окружения:

```bash
TOKEN=1956423829:AAGv7cB5DqxQFVHz2Sz
MONGO_DB_NAME=univision
MONGO_HOST=localhost
MONGO_PORT=27017
```

1. Что на сервере запущена mongodb
2. Что в файле [config.py](http://config.py) в массиве admins перечислены все телеграм id организаторов

Чтобы сбилдить докер в корне проекта выполняем команду:

```bash
make build
```

Чтобы запустить докер контейнер:

```bash
make run
```

Чтобы сбилдить и сразу запустить:

```bash
make runn
```

Полезные материалы:

[Репозиторий с ботом](https://github.com/LSD-Learn-Strive-Develop/Univision-bot)

[Aiogram учебник](https://mastergroosha.github.io/aiogram-3-guide/)

[Курс по ботам для новичков на степике](https://stepik.org/course/120924/syllabus)

[Курс по ботам углубленный на степике](https://stepik.org/course/153850/syllabus)

[Чат aigram в тг](http://t.me/aiogram_pcr)

[aiogram_dialog](https://www.notion.so/aiogram_dialog-87e40bb016da4dfc96183ae0437624d8?pvs=21)

[fluentogram](https://www.notion.so/fluentogram-b353068e64ee444faf73c9db1f300d57?pvs=21)

## Команды

Посмотреть факультеты:

```bash
/show
```

Добавить факультет faculty в эту табличку (можно передать несколько факультетов, но каждый из них должен быть передан на новой строчке):

```bash
/add
faculty1
faculty2
```

Удалить факультет faculty из этой таблички:
```bash
/del faculty
```

Удалить все факультеты:
```bash
/del_all
```

Стартовать голосование номер number:
```bash
/event_start number
```

Остановить голосование номер number:
```bash
/event_stop number
```

Заменить название факультета у всех пользователей:
```bash
/replace_name
last_name
new_name
```

Выгрузить табличку с результатами голосования с номером number (вторым параметром можно указать единицу, тогда выгрузятся дополнительные поля):
```bash
/get_result number
```

Добавить Студенческие отряды:
```bash
/add_squads
st00001
st00001
```

Удалить студенческие отряды:
```bash
/del_squads
st00001
st00001
```

Добавить студентов КИО:
```bash
/add_kio
st00001
st00001
```

Удалить студентов КИО:
```bash
/del_kio
st00001
st00001
```

Удалить всех юзеров:
```bash
/drop_users
```

Получить представление юзера в БД:
```bash
/check_user
```

Сброс результатов голосования юзера:
```bash
/del_user_vote st062274
```

Удаление юзера из базы:
```bash
/del_user_data st062274
```

## Продакшн бот:

t.me/UnivisionVoteBot